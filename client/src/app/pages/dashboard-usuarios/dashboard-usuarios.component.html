<div class="dashboard-container">
  <div class="header">
    <h1>Gestión de Usuarios</h1>
    <button class="btn-crear" (click)="toggleFormulario()">
      {{ mostrarFormulario ? 'Cancelar' : '+ Nuevo Usuario' }}
    </button>
  </div>

  @if (mostrarFormulario) {
    <div class="formulario-container">
      <h2>Crear Nuevo Usuario</h2>
      <form (submit)="crearUsuario(); $event.preventDefault()">
        <div class="form-grid">
          <div class="form-group">
            <label>Nombre *</label>
            <input type="text" [(ngModel)]="nuevoUsuario.nombre" name="nombre" required>
          </div>

          <div class="form-group">
            <label>Apellido *</label>
            <input type="text" [(ngModel)]="nuevoUsuario.apellido" name="apellido" required>
          </div>

          <div class="form-group">
            <label>Email *</label>
            <input type="email" [(ngModel)]="nuevoUsuario.email" name="email" required>
          </div>

          <div class="form-group">
            <label>Nombre de Usuario *</label>
            <input type="text" [(ngModel)]="nuevoUsuario.nombreUsuario" name="nombreUsuario" required>
          </div>

          <div class="form-group">
            <label>Contraseña *</label>
            <input type="password" [(ngModel)]="nuevoUsuario.password" name="password" required>
            <small>Mínimo 8 caracteres, una mayúscula y un número</small>
          </div>

          <div class="form-group">
            <label>Fecha de Nacimiento *</label>
            <input type="date" [(ngModel)]="nuevoUsuario.fechaNacimiento" name="fechaNacimiento" required>
          </div>
        </div>

        <div class="form-group">
          <label>Perfil *</label>
          <div class="radio-group">
            <label class="radio-label">
              <input type="radio" [(ngModel)]="nuevoUsuario.perfil" name="perfil" value="usuario">
              Usuario
            </label>
            <label class="radio-label">
              <input type="radio" [(ngModel)]="nuevoUsuario.perfil" name="perfil" value="administrador">
              Administrador
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="cargando">
            {{ cargando ? 'Creando...' : 'Crear Usuario' }}
          </button>
        </div>
      </form>
    </div>
  }

  @if (cargando && !mostrarFormulario) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando usuarios...</p>
    </div>
  }

  @if (!cargando && !mostrarFormulario) {
    <div class="tabla-container">
      <table class="tabla-usuarios">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Usuario</th>
            <th>Perfil</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (usuario of usuarios; track getUsuarioId(usuario)) {
            <tr [class.inactivo]="!usuario.activo">
              <td>{{ usuario.nombre }} {{ usuario.apellido }}</td>
              <td>{{ usuario.email }}</td>
              <td>{{ usuario.nombreUsuario }}</td>
              <td>
                <span class="badge" [class.badge-admin]="usuario.perfil === 'administrador'">
                  {{ usuario.perfil }}
                </span>
              </td>
              <td>
                <span class="estado" [class.activo]="usuario.activo" [class.inactivo-badge]="!usuario.activo">
                  {{ usuario.activo ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td>
                @if (usuario.activo) {
                  <button class="btn-deshabilitar" (click)="openConfirm('deshabilitar', usuario)">
                    Deshabilitar
                  </button>
                } @else {
                  <button class="btn-habilitar" (click)="openConfirm('habilitar', usuario)">
                    Habilitar
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
  
  <!-- Confirm Modal -->
  @if (showConfirmModal) {
    <div class="modal-overlay" (click)="cancelModal()"></div>
    <div class="modal-box">
      <h3>{{ confirmAction === 'deshabilitar' ? 'Confirmar deshabilitación' : 'Confirmar habilitación' }}</h3>
      <p>
        {{ confirmAction === 'deshabilitar' ? '¿Estás seguro de deshabilitar este usuario? No podrá acceder a la aplicación.' : '¿Estás seguro de habilitar este usuario?' }}
      </p>
      @if (confirmTarget) {
        <p><strong>{{ confirmTarget.nombre }} {{ confirmTarget.apellido }} ({{ confirmTarget.nombreUsuario }})</strong></p>
      }
      <div class="modal-actions">
        <button class="btn-secondary" (click)="cancelModal()" [disabled]="confirmLoading">Cancelar</button>
        <button class="btn-primary" (click)="confirmModal()" [disabled]="confirmLoading">
          {{ confirmLoading ? (confirmAction === 'deshabilitar' ? 'Deshabilitando...' : 'Habilitando...') : (confirmAction === 'deshabilitar' ? 'Deshabilitar' : 'Habilitar') }}
        </button>
      </div>
    </div>
  }

  <!-- Notification Modal -->
  @if (showNotificationModal) {
    <div class="modal-overlay" (click)="closeNotification()"></div>
    <div class="modal-box notification-modal" [class.success]="notificationType === 'success'" [class.error]="notificationType === 'error'" [class.warning]="notificationType === 'warning'">
      <div class="notification-icon">
        @if (notificationType === 'success') {
          <span class="icon-success">✓</span>
        }
        @if (notificationType === 'error') {
          <span class="icon-error">✗</span>
        }
        @if (notificationType === 'warning') {
          <span class="icon-warning">⚠</span>
        }
      </div>
      <p class="notification-text">{{ notificationMessage }}</p>
      <div class="modal-actions">
        <button class="btn-primary" (click)="closeNotification()">Aceptar</button>
      </div>
    </div>
  }
</div>
