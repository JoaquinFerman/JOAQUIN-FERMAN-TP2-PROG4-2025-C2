@if (usuario) {
  <div class="modal-perfil">
    <button class="btn-cerrar" (click)="cerrar()">‚úï</button>
    
    <div class="perfil-container">
      <!-- Secci√≥n de foto e info b√°sica -->
      <div class="perfil-header">
        <div class="foto-container">
          @if (editMode && previewUrl) {
            <img [src]="previewUrl" alt="Vista previa" class="foto-perfil">
          } @else if (usuario.foto || usuario.imagenPerfil) {
            <img [src]="usuario.foto || usuario.imagenPerfil" alt="Foto de perfil" class="foto-perfil">
          } @else {
            <div class="foto-placeholder">
              <span>{{ (usuario.nombre || usuario.username || 'U')[0].toUpperCase() }}</span>
            </div>
          }
          
          @if (editMode) {
            <label class="btn-cambiar-foto">
              üì∑ Cambiar foto
              <input type="file" accept="image/*" (change)="onFileSelected($event)" style="display: none;">
            </label>
          }
        </div>
        
        @if (!editMode) {
          <div class="info-principal">
            <h2>{{ usuario.nombre }} {{ usuario.apellido }}</h2>
            <p class="username">@{{ usuario.username }}</p>
            <p class="perfil-tipo">{{ usuario.perfil || 'Usuario' }}</p>
          </div>
        }
      </div>

      <!-- Formulario de edici√≥n o vista de datos -->
      @if (!editMode) {
        <div class="datos-detalle">
          <div class="dato-item">
            <label>Email</label>
            <span>{{ usuario.email }}</span>
          </div>
          <div class="dato-item">
            <label>Nombre de usuario</label>
            <span>{{ usuario.username }}</span>
          </div>
          <div class="dato-item">
            <label>Nombre</label>
            <span>{{ usuario.nombre }}</span>
          </div>
          <div class="dato-item">
            <label>Apellido</label>
            <span>{{ usuario.apellido || 'No especificado' }}</span>
          </div>
          <div class="dato-item">
            <label>Tipo de perfil</label>
            <span>{{ usuario.perfil || 'Usuario' }}</span>
          </div>
          @if (usuario.fechaRegistro) {
            <div class="dato-item">
              <label>Miembro desde</label>
              <span>{{ usuario.fechaRegistro | date:'dd/MM/yyyy' }}</span>
            </div>
          }
        </div>

        <div class="acciones">
          <button class="btn-editar" (click)="editar()">Editar perfil</button>
          <button class="btn-logout" (click)="logout()">Cerrar sesi√≥n</button>
        </div>
      } @else {
        <div class="formulario-edicion">
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" [(ngModel)]="usuarioEdit.nombre" placeholder="Nombre">
          </div>
          <div class="form-group">
            <label>Apellido</label>
            <input type="text" [(ngModel)]="usuarioEdit.apellido" placeholder="Apellido">
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" [(ngModel)]="usuarioEdit.email" placeholder="Email">
          </div>
          <div class="form-group">
            <label>Nombre de usuario</label>
            <input type="text" [(ngModel)]="usuarioEdit.nombreUsuario" placeholder="Username">
          </div>
          
          <div class="acciones-edicion">
            <button class="btn-cancelar" (click)="cancelarEdicion()">Cancelar</button>
            <button class="btn-guardar" (click)="guardarEdicion()">Guardar cambios</button>
          </div>
        </div>
      }

      <!-- Estad√≠sticas -->
      @if (!editMode) {
        <div class="estadisticas">
          <div class="stat-item">
            <span class="stat-numero">{{ cantidadPublicaciones }}</span>
            <span class="stat-label">Publicaciones</span>
          </div>
        </div>
      }

      <!-- Publicaciones recientes (compactas) -->
      @if (!editMode && ultimosTresPosts.length > 0) {
        <div class="publicaciones-recientes">
          <h3>Publicaciones recientes</h3>
          <div class="posts-grid">
            @for (pub of ultimosTresPosts; track pub._id || pub.id) {
              <div class="post-mini" (click)="verPublicacion(pub._id || pub.id)" style="cursor: pointer;">
                <p class="post-content">{{ pub.content }}</p>
                <div class="post-stats">
                  <span>‚ù§Ô∏è {{ pub.likesCount || 0 }}</span>
                  <span>üí¨ {{ pub.comments?.length || 0 }}</span>
                </div>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>
}

<!-- Modal de publicaci√≥n expandida -->
@if (publicacionExpandida) {
  <div class="modal-publicacion-overlay" (click)="cerrarPublicacionExpandida()">
    <div class="modal-publicacion-card" (click)="$event.stopPropagation()">
      <button class="btn-cerrar-publicacion" (click)="cerrarPublicacionExpandida()">‚úï</button>
      
      <div class="publicacion-expandida-header">
        <img [src]="publicacionExpandida.userPhoto || '/assets/default-avatar.png'" class="avatar-expandido" alt="Avatar">
        <div class="info-expandida">
          <h3>{{ publicacionExpandida.userName }}</h3>
          <span class="fecha-expandida">{{ publicacionExpandida.date | date:'short' }}</span>
        </div>
      </div>

      <div class="publicacion-expandida-contenido">
        <p>{{ publicacionExpandida.content }}</p>
        @if (publicacionExpandida.images && publicacionExpandida.images.length > 0) {
          <div class="imagenes-expandidas">
            @for (imagen of publicacionExpandida.images; track imagen) {
              <div class="imagen-container" (click)="verImagenCompleta(imagen)">
                <img [src]="imagen" alt="Imagen" class="imagen-expandida" (load)="onImageLoad($event)" (error)="onImageError($event)">
                <div class="imagen-loading">
                  <div class="spinner"></div>
                </div>
              </div>
            }
          </div>
        }
      </div>

      <div class="publicacion-expandida-stats">
        <span>‚ù§Ô∏è {{ publicacionExpandida.likesCount || 0 }} me gusta</span>
        <span>üí¨ {{ publicacionExpandida.comments?.length || 0 }} comentarios</span>
      </div>

      <div class="comentarios-expandidos">
        <h4>Comentarios</h4>
        @if (publicacionExpandida.comments && publicacionExpandida.comments.length > 0) {
          <div class="lista-comentarios-expandida">
            @for (comentario of publicacionExpandida.comments; track comentario) {
              <div class="comentario-expandido">
                <strong>{{ comentario.userName }}</strong>
                <p>{{ comentario.content }}</p>
                <small>{{ comentario.date | date:'short' }}</small>
              </div>
            }
          </div>
        } @else {
          <p class="sin-comentarios">No hay comentarios a√∫n</p>
        }
      </div>
    </div>
  </div>
}
